<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Dichotomium Scanner v1.3.0</title>
    
    <!-- –í–∞–∂–Ω–æ –¥–ª—è Telegram -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- CDN —Å—Å—ã–ª–∫–∏ -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è Telegram */
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            position: fixed;
            width: 100vw;
            height: 100vh;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        #ui {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .terminal {
            background: #111;
            border: 1px solid #0f0;
            padding: 25px;
            border-radius: 5px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }
        
        h1 {
            color: #0f0;
            margin-bottom: 10px;
            font-size: 22px;
        }
        
        #status {
            color: #0ff;
            margin: 15px 0;
            font-size: 16px;
            min-height: 20px;
        }
        
        #progress {
            width: 200px;
            height: 4px;
            background: #333;
            margin: 10px 0;
            border-radius: 2px;
            overflow: hidden;
        }
        
        #progress-bar {
            width: 0%;
            height: 100%;
            background: #0f0;
            transition: width 0.3s;
        }
        
        .scan-button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 15px 0;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }
        
        .scan-button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
        
        .hidden {
            display: none !important;
        }
        
        a-scene {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 999 !important;
        }
        
        #version {
            position: fixed;
            bottom: 10px;
            right: 10px;
            color: #666;
            font-size: 11px;
            z-index: 1001;
        }
        
        #debug {
            position: fixed;
            bottom: 30px;
            left: 10px;
            color: #888;
            font-size: 10px;
            z-index: 1001;
            background: rgba(0,0,0,0.7);
            padding: 5px;
            border-radius: 3px;
            max-width: 200px;
        }
    </style>
</head>
<body>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
            Telegram.WebApp.expand();
            Telegram.WebApp.setHeaderColor('#000000');
            Telegram.WebApp.setBackgroundColor('#000000');
        }
    </script>

    <div id="ui">
        <div class="terminal">
            <h1>>> DICHOTOMIUM SYSTEM</h1>
            <div id="status">PRELOADING ASSETS...</div>
            <div id="progress">
                <div id="progress-bar"></div>
            </div>
            <button id="startBtn" class="scan-button" disabled>
                INITIALIZE SCANNER
            </button>
            <div style="color: #666; font-size: 12px; margin-top: 20px;">
                Loading 3D model and AR data...
            </div>
        </div>
    </div>
    
    <div id="version">v1.3.0</div>
    <div id="debug">INIT: Starting preload...</div>
    
    <!-- AR —Å—Ü–µ–Ω–∞ —Å –∞—Å—Å–µ—Ç–∞–º–∏ –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ -->
    <a-scene id="arScene"
             renderer="alpha: true; antialias: true; precision: mediump;"
             vr-mode-ui="enabled: false"
             device-orientation-permission-ui="enabled: false"
             embedded
             class="hidden">
             
        <!-- –ê—Å—Å–µ—Ç—ã –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ -->
        <a-assets timeout="30000">
            <a-asset-item id="ring-model" src="Ring.glb" preload></a-asset-item>
        </a-assets>
        
        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ MindAR -->
        <a-entity mindar-image="imageTargetSrc: targets.mind; 
                                autoStart: false;
                                filterMinCF: 0.0001;
                                filterBeta: 0.001;
                                missTolerance: 10;
                                warmupTolerance: 0;
                                maxTrack: 1;
                                uiScanning: no;
                                uiLoading: no;">
        </a-entity>
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–æ–¥–µ–ª–∏ (—Å–Ω–∞—á–∞–ª–∞ –ø—É—Å—Ç–æ–π) -->
        <a-entity id="target-container" mindar-image-target="targetIndex: 0">
            <!-- –ú–æ–¥–µ–ª—å –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ -->
        </a-entity>
        
        <!-- –†–µ–∑–µ—Ä–≤–Ω—ã–π –æ–±—ä–µ–∫—Ç –Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º —Å –º–æ–¥–µ–ª—å—é -->
        <a-entity id="fallback-object" visible="false">
            <a-torus color="#0f0" radius="0.1" radius-tubular="0.02"
                    animation="property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear">
            </a-torus>
        </a-entity>
        
        <!-- –û—Å–≤–µ—â–µ–Ω–∏–µ -->
        <a-light type="ambient" color="#FFF" intensity="0.8"></a-light>
        <a-light type="directional" position="2 5 3" intensity="0.6" cast-shadow></a-light>
    </a-scene>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –í–ï–†–°–ò–ò ==========
        const APP_VERSION = '1.3.0';
        const BUILD_DATE = '2024.01.15.2';
        // =========================================
        
        document.getElementById('version').textContent = `v${APP_VERSION} (${BUILD_DATE})`;
        
        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        const ui = document.getElementById('ui');
        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const progressBar = document.getElementById('progress-bar');
        const debug = document.getElementById('debug');
        const arScene = document.getElementById('arScene');
        const targetContainer = document.getElementById('target-container');
        const fallbackObject = document.getElementById('fallback-object');
        
        let arReady = false;
        let modelLoaded = false;
        let mindarSystem = null;
        let isTelegram = typeof Telegram !== 'undefined' && Telegram.WebApp;
        
        // ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï DEBUG ==========
        function updateDebug(msg) {
            debug.textContent = `DEBUG: ${msg}`;
            console.log(msg);
        }
        
        function updateProgress(percent, message) {
            progressBar.style.width = `${percent}%`;
            status.textContent = message;
            updateDebug(`${message} (${percent}%)`);
        }
        
        // ========== –ü–†–ï–î–ó–ê–ì–†–£–ó–ö–ê –ú–û–î–ï–õ–ò ==========
        async function preloadModel() {
            updateProgress(10, 'Checking model file...');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–∞
                const response = await fetch('Ring.glb');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const size = response.headers.get('content-length');
                updateProgress(30, `Model found: ${size ? Math.round(size/1024) + 'KB' : 'size unknown'}`);
                
                // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏
                const preloadEl = document.createElement('a-entity');
                preloadEl.setAttribute('gltf-model', 'Ring.glb');
                preloadEl.setAttribute('visible', 'false');
                preloadEl.setAttribute('position', '0 -100 0'); // –î–∞–ª–µ–∫–æ –æ—Ç –∫–∞–º–µ—Ä—ã
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å—Ü–µ–Ω—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
                arScene.appendChild(preloadEl);
                
                // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏
                return new Promise((resolve, reject) => {
                    let timeout = setTimeout(() => {
                        reject(new Error('Model loading timeout (30s)'));
                    }, 30000);
                    
                    preloadEl.addEventListener('model-loaded', () => {
                        clearTimeout(timeout);
                        updateProgress(80, 'Model loaded successfully');
                        modelLoaded = true;
                        
                        // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
                        setTimeout(() => {
                            arScene.removeChild(preloadEl);
                            resolve(true);
                        }, 100);
                    });
                    
                    preloadEl.addEventListener('model-error', (evt) => {
                        clearTimeout(timeout);
                        reject(new Error(`Model error: ${evt.detail.src}`));
                    });
                });
                
            } catch (error) {
                updateDebug(`Model preload error: ${error.message}`);
                return false;
            }
        }
        
        // ========== –î–û–ë–ê–í–õ–ï–ù–ò–ï –ú–û–î–ï–õ–ò –í –°–¶–ï–ù–£ ==========
        function addModelToScene() {
            if (modelLoaded) {
                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–µ–ª—å —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                const model = document.createElement('a-entity');
                model.setAttribute('gltf-model', '#ring-model');
                model.setAttribute('position', '0 0 0');
                model.setAttribute('rotation', '0 0 0');
                model.setAttribute('scale', '0.1 0.1 0.1');
                model.setAttribute('animation', {
                    property: 'rotation',
                    to: '0 360 0',
                    loop: true,
                    dur: 10000,
                    easing: 'linear'
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
                model.setAttribute('smooth-transform', {
                    positionSmoothing: 0.15,
                    rotationSmoothing: 0.1,
                    scaleSmoothing: 0.1
                });
                
                // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –¥–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–µ–ª—å
                targetContainer.innerHTML = '';
                targetContainer.appendChild(model);
                updateDebug('Model added to scene');
                
            } else {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback –æ–±—ä–µ–∫—Ç
                const fallbackClone = fallbackObject.cloneNode(true);
                fallbackClone.setAttribute('visible', 'true');
                targetContainer.appendChild(fallbackClone);
                updateDebug('Using fallback object (model not loaded)');
            }
        }
        
        // ========== –ö–û–ú–ü–û–ù–ï–ù–¢ SMOOTH-TRANSFORM ==========
        AFRAME.registerComponent('smooth-transform', {
            schema: {
                positionSmoothing: { type: 'number', default: 0.15 },
                rotationSmoothing: { type: 'number', default: 0.1 },
                scaleSmoothing: { type: 'number', default: 0.1 }
            },

            init: function() {
                this.targetPosition = new THREE.Vector3();
                this.targetRotation = new THREE.Euler();
                this.targetScale = new THREE.Vector3();
                
                this.currentPosition = new THREE.Vector3();
                this.currentRotation = new THREE.Euler();
                this.currentScale = new THREE.Vector3();
                
                const current = this.el.object3D;
                this.currentPosition.copy(current.position);
                this.currentRotation.copy(current.rotation);
                this.currentScale.copy(current.scale);
            },

            tick: function(time, deltaTime) {
                const el = this.el;
                const data = this.data;
                
                this.targetPosition.copy(el.object3D.position);
                this.targetRotation.copy(el.object3D.rotation);
                this.targetScale.copy(el.object3D.scale);
                
                this.currentPosition.lerp(this.targetPosition, data.positionSmoothing);
                this.currentRotation.x = THREE.MathUtils.lerp(
                    this.currentRotation.x, 
                    this.targetRotation.x, 
                    data.rotationSmoothing
                );
                this.currentRotation.y = THREE.MathUtils.lerp(
                    this.currentRotation.y, 
                    this.targetRotation.y, 
                    data.rotationSmoothing
                );
                this.currentRotation.z = THREE.MathUtils.lerp(
                    this.currentRotation.z, 
                    this.targetRotation.z, 
                    data.rotationSmoothing
                );
                this.currentScale.lerp(this.targetScale, data.scaleSmoothing);
                
                el.object3D.position.copy(this.currentPosition);
                el.object3D.rotation.copy(this.currentRotation);
                el.object3D.scale.copy(this.currentScale);
            }
        });
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø AR –°–ò–°–¢–ï–ú–´ ==========
        async function initAR() {
            updateProgress(0, 'Starting initialization...');
            
            try {
                // –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ A-Frame
                updateProgress(5, 'Loading A-Frame...');
                await waitForAFrame();
                
                // –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ MindAR
                updateProgress(15, 'Loading MindAR...');
                await waitForMindAR();
                
                // –®–∞–≥ 3: –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏
                updateProgress(25, 'Preloading 3D model...');
                await preloadModel();
                
                // –®–∞–≥ 4: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ü–µ–Ω—ã
                updateProgress(90, 'Initializing AR scene...');
                mindarSystem = arScene.systems['mindar-image-system'];
                
                if (!mindarSystem) {
                    throw new Error('MindAR system not found');
                }
                
                // –í—Å–µ –≥–æ—Ç–æ–≤–æ
                updateProgress(100, 'System ready!');
                arReady = true;
                startBtn.disabled = false;
                
                updateDebug('‚úÖ AR system initialized successfully');
                
            } catch (error) {
                updateDebug(`‚ùå Initialization error: ${error.message}`);
                status.textContent = `ERROR: ${error.message}`;
                startBtn.disabled = true;
            }
        }
        
        function waitForAFrame() {
            return new Promise((resolve) => {
                if (typeof AFRAME !== 'undefined') {
                    updateDebug(`A-Frame v${AFRAME.version} loaded`);
                    resolve();
                } else {
                    const check = setInterval(() => {
                        if (typeof AFRAME !== 'undefined') {
                            clearInterval(check);
                            updateDebug(`A-Frame v${AFRAME.version} loaded`);
                            resolve();
                        }
                    }, 100);
                }
            });
        }
        
        function waitForMindAR() {
            return new Promise((resolve) => {
                if (AFRAME.systems && AFRAME.systems['mindar-image-system']) {
                    updateDebug('MindAR system loaded');
                    resolve();
                } else {
                    const check = setInterval(() => {
                        if (AFRAME.systems && AFRAME.systems['mindar-image-system']) {
                            clearInterval(check);
                            updateDebug('MindAR system loaded');
                            resolve();
                        }
                    }, 100);
                }
            });
        }
        
        // ========== –ó–ê–ü–£–°–ö –°–ö–ê–ù–ï–†–ê ==========
        startBtn.addEventListener('click', async () => {
            if (!arReady) return;
            
            status.textContent = 'Requesting camera access...';
            startBtn.disabled = true;
            
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                stream.getTracks().forEach(track => track.stop());
                updateDebug('Camera access granted');
                
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ AR —Ä–µ–∂–∏–º
                ui.classList.add('hidden');
                arScene.classList.remove('hidden');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–µ–ª—å –≤ —Å—Ü–µ–Ω—É
                addModelToScene();
                
                // –î–∞–µ–º —Å—Ü–µ–Ω–µ –≤—Ä–µ–º—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                setTimeout(() => {
                    mindarSystem.start();
                    updateDebug('AR scanner started');
                    
                    // –¢–∞–∫—Ç–∏–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫ –≤ Telegram
                    if (isTelegram) {
                        Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                        Telegram.WebApp.BackButton.show();
                    }
                }, 500);
                
            } catch (error) {
                updateDebug(`Camera error: ${error.name}`);
                status.textContent = 'Camera error';
                startBtn.disabled = false;
                
                if (isTelegram) {
                    Telegram.WebApp.showAlert(`Camera error: ${error.message}`);
                }
            }
        });
        
        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô AR ==========
        arScene.addEventListener('arReady', () => {
            updateDebug('AR system ready');
        });
        
        arScene.addEventListener('targetFound', () => {
            updateDebug('üéØ Target found - model should be visible');
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏
            setTimeout(() => {
                const model = targetContainer.querySelector('[gltf-model]') || 
                              targetContainer.querySelector('a-torus');
                if (model) {
                    model.setAttribute('visible', 'true');
                    updateDebug('Model visibility confirmed');
                }
            }, 100);
            
            if (isTelegram) {
                Telegram.WebApp.HapticFeedback.impactOccurred('light');
            }
        });
        
        arScene.addEventListener('targetLost', () => {
            updateDebug('Target lost');
        });
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        setTimeout(() => {
            initAR();
            updateDebug(`=== Dichotomium Scanner v${APP_VERSION} ===`);
            updateDebug(`Build: ${BUILD_DATE}`);
            updateDebug(`Platform: ${isTelegram ? 'Telegram' : 'Browser'}`);
        }, 500);
        
        // ========== –ö–ù–û–ü–ö–ê –ù–ê–ó–ê–î –í TELEGRAM ==========
        if (isTelegram) {
            Telegram.WebApp.BackButton.onClick(() => {
                if (!arScene.classList.contains('hidden')) {
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ UI
                    arScene.classList.add('hidden');
                    ui.classList.remove('hidden');
                    Telegram.WebApp.BackButton.hide();
                    
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º AR
                    if (mindarSystem) {
                        mindarSystem.stop();
                    }
                    
                    updateDebug('Returned to menu');
                }
            });
        }
        
        // ========== –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ê –ü–†–ò –ü–†–û–ë–õ–ï–ú–ê–• ==========
        window.addEventListener('beforeunload', () => {
            if (mindarSystem) {
                mindarSystem.stop();
            }
        });
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
        if (performance.navigation.type === 1 || performance.getEntriesByType("navigation")[0]?.type === 'reload') {
            updateDebug('Page reloaded - forcing fresh load');
        }
    </script>
</body>
</html>