<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Scanner - Local Version</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã -->
    <script src="aframe.min.js"></script>
    <script src="mindar-image-aframe.prod.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #0f0;
            font-family: monospace;
            overflow: hidden;
        }
        
        #startScreen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .console {
            background: #111;
            border: 2px solid #0f0;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 500px;
        }
        
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
        
        #status {
            margin: 15px 0;
            color: #0ff;
        }
        
        #error {
            color: #f00;
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,0,0,0.1);
            border-radius: 5px;
            display: none;
        }
        
        #trackingInfo {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            color: #0f0;
            z-index: 1001;
            display: none;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="startScreen">
        <div class="console">
            <h1>üß¨ AR SCANNER</h1>
            <div id="status">Loading AR system...</div>
            <button id="startBtn" disabled>INITIALIZE SCANNER</button>
            <div id="error"></div>
            <div style="margin-top: 20px; color: #888; font-size: 12px;">
                Local build | No CDN required
            </div>
        </div>
    </div>
    
    <div id="trackingInfo">
        Status: <span id="trackingStatus">INACTIVE</span>
    </div>
    
    <!-- AR —Å—Ü–µ–Ω–∞ -->
    <a-scene id="arScene" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false"
             embedded
             class="hidden">
    </a-scene>

    <script>
        console.log("=== AR System Initialization ===");
        
        const startScreen = document.getElementById('startScreen');
        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const errorDiv = document.getElementById('error');
        const trackingInfo = document.getElementById('trackingInfo');
        const trackingStatus = document.getElementById('trackingStatus');
        const arScene = document.getElementById('arScene');
        
        let checkCount = 0;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫
        function checkLibraries() {
            checkCount++;
            
            if (typeof AFRAME === 'undefined') {
                status.textContent = `Loading A-Frame... (${checkCount})`;
                if (checkCount < 30) {
                    setTimeout(checkLibraries, 500);
                } else {
                    showError("A-Frame failed to load");
                }
                return;
            }
            
            console.log("‚úÖ A-Frame loaded:", AFRAME.version);
            
            if (!AFRAME.systems || !AFRAME.systems['mindar-image-system']) {
                status.textContent = `Loading MindAR... (${checkCount})`;
                if (checkCount < 30) {
                    setTimeout(checkLibraries, 500);
                } else {
                    showError("MindAR failed to load");
                }
                return;
            }
            
            console.log("‚úÖ MindAR system found");
            status.textContent = "System ready!";
            startBtn.disabled = false;
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            console.error(message);
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            status.textContent = "Error";
        }
        
        // –ó–∞–ø—É—Å–∫ AR
        startBtn.addEventListener('click', async function() {
            status.textContent = "Requesting camera...";
            startBtn.disabled = true;
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–º–µ—Ä—É
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                stream.getTracks().forEach(track => track.stop());
                
                // –°–æ–∑–¥–∞–µ–º AR —Å—Ü–µ–Ω—É
                createARScene();
                
            } catch (err) {
                console.error("Camera error:", err);
                let errorMsg = "Camera error: ";
                if (err.name === 'NotAllowedError') {
                    errorMsg = "Please allow camera access";
                } else if (err.name === 'NotFoundError') {
                    errorMsg = "No camera found";
                } else {
                    errorMsg += err.message;
                }
                showError(errorMsg);
                startBtn.disabled = false;
            }
        });
        
        // –°–æ–∑–¥–∞–Ω–∏–µ AR —Å—Ü–µ–Ω—ã
        function createARScene() {
            status.textContent = "Creating AR environment...";
            
            // –û—á–∏—â–∞–µ–º —Å—Ü–µ–Ω—É
            arScene.innerHTML = '';
            
            // –£–ª—É—á—à–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
            const mindarConfig = {
                imageTargetSrc: 'targets.mind',
                autoStart: false,
                filterMinCF: 0.01,    // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
                filterBeta: 1000,     // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
                missTolerance: 0,     // –¢–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–ø–∞–¥–∞–Ω–∏—é
                warmupTolerance: 0,   // –¢–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫ —Ä–∞–∑–æ–≥—Ä–µ–≤—É
                maxTrack: 1           // –ú–∞–∫—Å–∏–º—É–º –æ–¥–∏–Ω —Ç—Ä–µ–∫
            };
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞—Ç—Ä–∏–±—É—Ç mindar-image
            arScene.setAttribute('mindar-image', 
                `imageTargetSrc: ${mindarConfig.imageTargetSrc};
                 autoStart: ${mindarConfig.autoStart};
                 filterMinCF: ${mindarConfig.filterMinCF};
                 filterBeta: ${mindarConfig.filterBeta};
                 missTolerance: ${mindarConfig.missTolerance};
                 warmupTolerance: ${mindarConfig.warmupTolerance};
                 maxTrack: ${mindarConfig.maxTrack};`
            );
            
            // –ö–∞–º–µ—Ä–∞
            const camera = document.createElement('a-camera');
            camera.setAttribute('position', '0 0 0');
            camera.setAttribute('look-controls', 'enabled: false');
            arScene.appendChild(camera);
            
            // –¢–∞—Ä–≥–µ—Ç —Å –º–æ–¥–µ–ª—å—é
            const target = document.createElement('a-entity');
            target.setAttribute('mindar-image-target', 'targetIndex: 0');
            
            const model = document.createElement('a-gltf-model');
            model.setAttribute('src', 'Ring.glb');
            model.setAttribute('position', '0 0 0');
            model.setAttribute('rotation', '0 0 0');
            model.setAttribute('scale', '0.1 0.1 0.1');
            
            // –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è
            model.setAttribute('animation', {
                property: 'rotation',
                to: '0 360 0',
                loop: true,
                dur: 10000,
                easing: 'linear'
            });
            
            target.appendChild(model);
            arScene.appendChild(target);
            
            // –û—Å–≤–µ—â–µ–Ω–∏–µ
            const ambientLight = document.createElement('a-light');
            ambientLight.setAttribute('type', 'ambient');
            ambientLight.setAttribute('color', '#FFF');
            ambientLight.setAttribute('intensity', '0.6');
            arScene.appendChild(ambientLight);
            
            const directionalLight = document.createElement('a-light');
            directionalLight.setAttribute('type', 'directional');
            directionalLight.setAttribute('position', '1 1 1');
            directionalLight.setAttribute('intensity', '0.4');
            arScene.appendChild(directionalLight);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ü–µ–Ω—É
            arScene.classList.remove('hidden');
            startScreen.classList.add('hidden');
            trackingInfo.style.display = 'block';
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º MindAR –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ü–µ–Ω—ã
            arScene.addEventListener('loaded', function() {
                const mindarSystem = arScene.systems['mindar-image-system'];
                if (mindarSystem) {
                    mindarSystem.start();
                    console.log("AR system started");
                    status.textContent = "AR active";
                }
            });
            
            // –°–æ–±—ã—Ç–∏—è —Ç—Ä–µ–∫–∏–Ω–≥–∞
            arScene.addEventListener('targetFound', function() {
                trackingStatus.textContent = 'ACTIVE';
                trackingStatus.style.color = '#0f0';
                console.log("Target found");
            });
            
            arScene.addEventListener('targetLost', function() {
                trackingStatus.textContent = 'SEARCHING';
                trackingStatus.style.color = '#ff0';
                console.log("Target lost");
            });
            
            arScene.addEventListener('arError', function(event) {
                console.error("AR error:", event.detail.error);
                trackingStatus.textContent = 'ERROR';
                trackingStatus.style.color = '#f00';
                showError("AR Error: " + event.detail.error);
            });
        }
        
        // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –±–∏–±–ª–∏–æ—Ç–µ–∫
        setTimeout(checkLibraries, 500);
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        console.log("Page URL:", window.location.href);
        console.log("User Agent:", navigator.userAgent);
    </script>
</body>
</html>