<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AR Scanner</title>
    
    <!-- CDN –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ—á–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç -->
    <script src="https://unpkg.com/aframe@1.4.0/dist/aframe.min.js"></script>
    <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ —Å–∫–∞—á–∞–Ω–Ω—ã–π MindAR –ª–æ–∫–∞–ª—å–Ω–æ -->
    <script src="mindar-image-aframe.prod.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #000; 
            color: #0f0; 
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }
        
        #loader {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        .terminal {
            background: #111;
            border: 2px solid #0f0;
            border-radius: 5px;
            padding: 30px;
            max-width: 500px;
            margin: 20px;
        }
        
        .status-line {
            margin: 10px 0;
            color: #0f0;
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 30px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        
        button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
        
        #error {
            color: #f00;
            background: rgba(255,0,0,0.1);
            padding: 10px;
            border-radius: 3px;
            margin-top: 20px;
            display: none;
        }
        
        #debug {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 12px;
            color: #888;
        }
    </style>
</head>
<body>
    <div id="loader">
        <div class="terminal">
            <h2>üß¨ AR SYSTEM v1.0</h2>
            <div class="status-line">>>> Initializing system...</div>
            <div class="status-line">>>> Checking modules...</div>
            <div class="status-line">>>> A-Frame: <span id="aframe-check">‚ùì</span></div>
            <div class="status-line">>>> MindAR: <span id="mindar-check">‚ùì</span></div>
            <div class="status-line">>>> Camera: <span id="camera-check">‚ùì</span></div>
            <div class="status-line blink" id="status">LOADING...</div>
            
            <button id="start-btn" disabled>üö´ INITIALIZE SCANNER</button>
            
            <div id="error"></div>
            
            <div style="margin-top: 30px; font-size: 12px; color: #666;">
                beton22.github.io | Android AR Test
            </div>
        </div>
    </div>
    
    <!-- –°—Ü–µ–Ω–∞ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    <div id="scene-container"></div>
    
    <div id="debug">
        Console: <span id="console-status">Waiting...</span>
    </div>

    <script>
        console.log("=== AR SYSTEM START ===");
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const loader = document.getElementById('loader');
        const startBtn = document.getElementById('start-btn');
        const status = document.getElementById('status');
        const errorDiv = document.getElementById('error');
        const debugStatus = document.getElementById('console-status');
        const aframeCheck = document.getElementById('aframe-check');
        const mindarCheck = document.getElementById('mindar-check');
        const cameraCheck = document.getElementById('camera-check');
        
        let systemReady = false;
        let checkCounter = 0;
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(text, color) {
            status.textContent = text;
            status.style.color = color || '#0f0';
            debugStatus.textContent = text;
            console.log(text);
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            console.error(message);
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            updateStatus('ERROR', '#f00');
            startBtn.disabled = true;
            startBtn.textContent = '‚ùå ERROR';
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫
        function checkLibraries() {
            checkCounter++;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º A-Frame
            if (typeof AFRAME === 'undefined') {
                aframeCheck.textContent = '‚åõ Loading...';
                if (checkCounter < 30) { // 30 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
                    setTimeout(checkLibraries, 1000);
                } else {
                    showError("A-Frame –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä (Chrome)");
                }
                return;
            }
            
            aframeCheck.textContent = '‚úÖ Loaded v' + AFRAME.version;
            console.log("A-Frame version:", AFRAME.version);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º MindAR
            if (!AFRAME.systems || !AFRAME.systems['mindar-image-system']) {
                mindarCheck.textContent = '‚åõ Loading...';
                if (checkCounter < 30) {
                    setTimeout(checkLibraries, 1000);
                } else {
                    showError("MindAR –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª mindar-image-aframe.prod.js");
                }
                return;
            }
            
            mindarCheck.textContent = '‚úÖ Loaded';
            console.log("MindAR system detected");
            
            // –í—Å–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            systemReady = true;
            updateStatus('>>> SYSTEM READY');
            startBtn.disabled = false;
            startBtn.textContent = 'üé• ACTIVATE AR SCANNER';
            startBtn.style.background = '#0f0';
            startBtn.style.color = '#000';
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ AR —Å—Ü–µ–Ω—ã
        function createARScene() {
            updateStatus('Creating AR environment...');
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å—Ü–µ–Ω—É –µ—Å–ª–∏ –µ—Å—Ç—å
            const oldScene = document.querySelector('a-scene');
            if (oldScene) oldScene.parentNode.removeChild(oldScene);
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ü–µ–Ω—É
            const scene = document.createElement('a-scene');
            scene.setAttribute('mindar-image', 
                `imageTargetSrc: targets.mind; 
                 autoStart: false;
                 filterMinCF: 0.001;
                 filterBeta: 0.01;`
            );
            scene.setAttribute('vr-mode-ui', 'enabled: false');
            scene.setAttribute('device-orientation-permission-ui', 'enabled: false');
            scene.setAttribute('embedded', '');
            scene.style.width = '100%';
            scene.style.height = '100vh';
            scene.style.position = 'fixed';
            scene.style.top = '0';
            scene.style.left = '0';
            
            // –ö–∞–º–µ—Ä–∞
            const camera = document.createElement('a-camera');
            camera.setAttribute('position', '0 0 0');
            camera.setAttribute('look-controls', 'enabled: false');
            scene.appendChild(camera);
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å targets.mind - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ —Ç–µ—Å—Ç–æ–≤—ã–π –æ–±—ä–µ–∫—Ç
            const target = document.createElement('a-entity');
            target.setAttribute('mindar-image-target', 'targetIndex: 0');
            
            const object = document.createElement('a-box');
            object.setAttribute('position', '0 0 0');
            object.setAttribute('color', '#00ff00');
            object.setAttribute('scale', '0.2 0.2 0.2');
            object.setAttribute('animation', 
                'property: rotation; to: 0 360 0; loop: true; dur: 10000'
            );
            
            target.appendChild(object);
            scene.appendChild(target);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–µ—Ç
            const ambientLight = document.createElement('a-light');
            ambientLight.setAttribute('type', 'ambient');
            ambientLight.setAttribute('color', '#fff');
            ambientLight.setAttribute('intensity', '0.6');
            scene.appendChild(ambientLight);
            
            const directionalLight = document.createElement('a-light');
            directionalLight.setAttribute('type', 'directional');
            directionalLight.setAttribute('position', '1 1 1');
            directionalLight.setAttribute('intensity', '0.4');
            scene.appendChild(directionalLight);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
            document.getElementById('scene-container').appendChild(scene);
            
            return scene;
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—É—Å–∫–∞
        startBtn.addEventListener('click', async function() {
            if (!systemReady) {
                showError("System not ready yet");
                return;
            }
            
            updateStatus('Requesting camera permission...');
            startBtn.disabled = true;
            startBtn.textContent = '‚è≥ REQUESTING CAMERA...';
            cameraCheck.textContent = '‚åõ Requesting...';
            
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ—Ç–æ–∫
                stream.getTracks().forEach(track => track.stop());
                
                cameraCheck.textContent = '‚úÖ Access granted';
                updateStatus('Camera access granted');
                
                // –°–æ–∑–¥–∞–µ–º AR —Å—Ü–µ–Ω—É
                const scene = createARScene();
                
                // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ü–µ–Ω—ã
                scene.addEventListener('loaded', function() {
                    updateStatus('Starting AR...');
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º MindAR
                    const mindarSystem = scene.systems['mindar-image-system'];
                    if (mindarSystem) {
                        mindarSystem.start();
                        
                        // –°–∫—Ä—ã–≤–∞–µ–º loader —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                        setTimeout(() => {
                            loader.style.display = 'none';
                            updateStatus('AR ACTIVE');
                            console.log("AR system started successfully!");
                        }, 1000);
                    } else {
                        showError("MindAR system not found in scene");
                    }
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫
                scene.addEventListener('arError', function(event) {
                    console.error("AR Error:", event.detail.error);
                    showError("AR Error: " + event.detail.error);
                });
                
                scene.addEventListener('targetFound', function() {
                    console.log("Target found!");
                    updateStatus('TARGET DETECTED', '#0ff');
                });
                
                scene.addEventListener('targetLost', function() {
                    updateStatus('SCANNING...');
                });
                
            } catch (error) {
                console.error("Camera error:", error);
                cameraCheck.textContent = '‚ùå Failed';
                
                if (error.name === 'NotAllowedError') {
                    showError("Camera permission denied. Please allow camera access in browser settings.");
                } else if (error.name === 'NotFoundError') {
                    showError("No camera found on this device.");
                } else if (error.name === 'NotSupportedError') {
                    showError("AR not supported in this browser.");
                } else {
                    showError("Camera error: " + error.message);
                }
                
                startBtn.disabled = false;
                startBtn.textContent = 'üîÑ RETRY';
            }
        });
        
        // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
        setTimeout(checkLibraries, 1000);
        
        // –ï—Å–ª–∏ —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ
        setTimeout(() => {
            if (!systemReady) {
                showError("Loading timeout. Check internet connection.");
                startBtn.disabled = false;
                startBtn.textContent = 'üîÑ RETRY';
                startBtn.onclick = () => location.reload();
            }
        }, 15000);
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–∞—É–∑–µ—Ä–µ
        console.log("User Agent:", navigator.userAgent);
        console.log("Platform:", navigator.platform);
    </script>
</body>
</html>