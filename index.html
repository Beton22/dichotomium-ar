<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Dichotomium Scanner v1.2.1</title>
    
    <!-- –í–∞–∂–Ω–æ –¥–ª—è Telegram -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- CDN —Å—Å—ã–ª–∫–∏ -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è Telegram */
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            position: fixed;
            width: 100vw;
            height: 100vh;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        #ui {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .terminal {
            background: #111;
            border: 1px solid #0f0;
            padding: 25px;
            border-radius: 5px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }
        
        h1 {
            color: #0f0;
            margin-bottom: 10px;
            font-size: 22px;
        }
        
        #status {
            color: #0ff;
            margin: 15px 0;
            font-size: 16px;
            min-height: 20px;
        }
        
        .scan-button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 15px 0;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }
        
        .scan-button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
        
        .hidden {
            display: none !important;
        }
        
        a-scene {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 999 !important;
        }
        
        #version {
            position: fixed;
            bottom: 10px;
            right: 10px;
            color: #666;
            font-size: 11px;
            z-index: 1001;
        }
        
        #debug {
            position: fixed;
            bottom: 10px;
            left: 10px;
            color: #888;
            font-size: 10px;
            z-index: 1001;
            background: rgba(0,0,0,0.7);
            padding: 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
            Telegram.WebApp.expand();
            Telegram.WebApp.setHeaderColor('#000000');
            Telegram.WebApp.setBackgroundColor('#000000');
        }
    </script>

    <div id="ui">
        <div class="terminal">
            <h1>>> DICHOTOMIUM SYSTEM</h1>
            <div id="status">INITIALIZING...</div>
            <button id="startBtn" class="scan-button" disabled>
                INITIALIZE SCANNER
            </button>
            <div style="color: #666; font-size: 12px; margin-top: 20px;">
                Point camera at glyph marker<br>
                Ensure adequate lighting
            </div>
        </div>
    </div>
    
    <div id="version">v1.2.1</div>
    <div id="debug">DEBUG: Initializing...</div>
    
    <!-- AR —Å—Ü–µ–Ω–∞ —Å –ö–û–ú–ë–ò–ù–ò–†–û–í–ê–ù–ù–´–ú–ò –ù–ê–°–¢–†–û–ô–ö–ê–ú–ò -->
    <a-scene id="arScene"
             renderer="alpha: true; antialias: true; precision: mediump;"
             vr-mode-ui="enabled: false"
             device-orientation-permission-ui="enabled: false"
             embedded
             class="hidden">
             
        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ MindAR -->
        <a-entity mindar-image="imageTargetSrc: targets.mind; 
                                autoStart: false;
                                filterMinCF: 0.0001;
                                filterBeta: 0.001;
                                missTolerance: 10;
                                warmupTolerance: 0;
                                maxTrack: 1;
                                uiScanning: no;
                                uiLoading: no;">
        </a-entity>
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        
        <!-- –ú–æ–¥–µ–ª—å —Å–æ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ–º -->
        <a-entity mindar-image-target="targetIndex: 0">
            <a-gltf-model id="ar-model"
                         src="Ring.glb"
                         position="0 0 0"
                         rotation="0 0 0"
                         scale="0.1 0.1 0.1"
                         smooth-transform="positionSmoothing: 0.15; rotationSmoothing: 0.1;"
                         animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear">
            </a-gltf-model>
        </a-entity>
        
        <!-- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ -->
        <a-light type="ambient" color="#FFF" intensity="0.5"></a-light>
        <a-light type="directional" position="1 1 1" intensity="0.3"></a-light>
    </a-scene>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –í–ï–†–°–ò–ò ==========
        const APP_VERSION = '1.2.1';
        const BUILD_DATE = '2024.01.15.1';
        // =========================================
        
        document.getElementById('version').textContent = `v${APP_VERSION} (${BUILD_DATE})`;
        
        // ========== –ö–û–ú–ü–û–ù–ï–ù–¢ SMOOTH-TRANSFORM ==========
        AFRAME.registerComponent('smooth-transform', {
            schema: {
                positionSmoothing: { type: 'number', default: 0.15 },
                rotationSmoothing: { type: 'number', default: 0.1 },
                scaleSmoothing: { type: 'number', default: 0.1 }
            },

            init: function() {
                console.log('Smooth transform initialized');
                this.targetPosition = new THREE.Vector3();
                this.targetRotation = new THREE.Euler();
                this.targetScale = new THREE.Vector3();
                
                this.currentPosition = new THREE.Vector3();
                this.currentRotation = new THREE.Euler();
                this.currentScale = new THREE.Vector3();
                
                const current = this.el.object3D;
                this.currentPosition.copy(current.position);
                this.currentRotation.copy(current.rotation);
                this.currentScale.copy(current.scale);
                
                this.el.addEventListener('model-loaded', () => {
                    console.log('Model loaded event in smooth-transform');
                });
            },

            tick: function(time, deltaTime) {
                const el = this.el;
                const data = this.data;
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ü–µ–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                this.targetPosition.copy(el.object3D.position);
                this.targetRotation.copy(el.object3D.rotation);
                this.targetScale.copy(el.object3D.scale);
                
                // –ü–ª–∞–≤–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
                this.currentPosition.lerp(this.targetPosition, data.positionSmoothing);
                this.currentRotation.x = THREE.MathUtils.lerp(
                    this.currentRotation.x, 
                    this.targetRotation.x, 
                    data.rotationSmoothing
                );
                this.currentRotation.y = THREE.MathUtils.lerp(
                    this.currentRotation.y, 
                    this.targetRotation.y, 
                    data.rotationSmoothing
                );
                this.currentRotation.z = THREE.MathUtils.lerp(
                    this.currentRotation.z, 
                    this.targetRotation.z, 
                    data.rotationSmoothing
                );
                this.currentScale.lerp(this.targetScale, data.scaleSmoothing);
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–≥–ª–∞–∂–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                el.object3D.position.copy(this.currentPosition);
                el.object3D.rotation.copy(this.currentRotation);
                el.object3D.scale.copy(this.currentScale);
            }
        });
        
        // ========== –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ==========
        const ui = document.getElementById('ui');
        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const debug = document.getElementById('debug');
        const arScene = document.getElementById('arScene');
        const arModel = document.getElementById('ar-model');
        
        let arReady = false;
        let checkCount = 0;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–∫–∏
        function updateDebug(msg) {
            debug.textContent = `DEBUG: ${msg}`;
            console.log(msg);
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫
        function initAR() {
            checkCount++;
            updateDebug(`Check ${checkCount}: AFRAME=${typeof AFRAME !== 'undefined'}`);
            
            if (typeof AFRAME === 'undefined') {
                status.textContent = `LOADING A-FRAME...`;
                if (checkCount < 30) setTimeout(initAR, 500);
                return;
            }
            
            updateDebug(`A-Frame v${AFRAME.version} loaded`);
            
            if (!AFRAME.systems || !AFRAME.systems['mindar-image-system']) {
                status.textContent = `LOADING MINDAR...`;
                if (checkCount < 30) setTimeout(initAR, 500);
                return;
            }
            
            updateDebug('MindAR system ready');
            arReady = true;
            status.textContent = 'SYSTEM READY';
            startBtn.disabled = false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏
        arModel.addEventListener('model-loaded', () => {
            updateDebug('3D model loaded successfully');
        });
        
        arModel.addEventListener('model-error', (evt) => {
            updateDebug(`Model error: ${evt.detail.src}`);
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        setTimeout(initAR, 500);
        
        // –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞
        startBtn.addEventListener('click', async () => {
            if (!arReady) return;
            
            status.textContent = 'REQUESTING CAMERA...';
            startBtn.disabled = true;
            updateDebug('Requesting camera access');
            
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                stream.getTracks().forEach(track => track.stop());
                updateDebug('Camera access granted');
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º AR
                ui.classList.add('hidden');
                arScene.classList.remove('hidden');
                
                const mindarSystem = arScene.systems['mindar-image-system'];
                if (mindarSystem) {
                    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
                    setTimeout(() => {
                        mindarSystem.start();
                        updateDebug('AR started with combined smoothing');
                        
                        // –¢–∞–∫—Ç–∏–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫ –≤ Telegram
                        if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
                            Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                        }
                    }, 500);
                }
                
            } catch (error) {
                updateDebug(`Camera error: ${error.name}`);
                status.textContent = 'CAMERA ERROR';
                startBtn.disabled = false;
                
                let errorMsg = '';
                if (error.name === 'NotAllowedError') {
                    errorMsg = 'Please allow camera access in Telegram settings';
                } else {
                    errorMsg = error.message;
                }
                
                if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
                    Telegram.WebApp.showAlert(errorMsg);
                }
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π AR
        arScene.addEventListener('loaded', () => {
            updateDebug('AR scene loaded');
        });
        
        arScene.addEventListener('arReady', () => {
            updateDebug('AR system ready');
        });
        
        arScene.addEventListener('targetFound', () => {
            updateDebug('üéØ Target found');
            if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
                Telegram.WebApp.HapticFeedback.impactOccurred('light');
            }
        });
        
        arScene.addEventListener('targetLost', () => {
            updateDebug('Target lost');
        });
        
        arScene.addEventListener('arError', (event) => {
            updateDebug(`AR Error: ${event.detail.error}`);
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –≤ Telegram
        if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
            Telegram.WebApp.BackButton.onClick(() => {
                if (!arScene.classList.contains('hidden')) {
                    arScene.classList.add('hidden');
                    ui.classList.remove('hidden');
                    Telegram.WebApp.BackButton.hide();
                    updateDebug('Returned to menu');
                }
            });
        }
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        console.log(`=== Dichotomium Scanner v${APP_VERSION} ===`);
        console.log(`Build: ${BUILD_DATE}`);
        console.log(`User Agent: ${navigator.userAgent}`);
        console.log(`Screen: ${window.screen.width}x${window.screen.height}`);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
        setTimeout(() => {
            fetch('Ring.glb')
                .then(response => {
                    if (response.ok) {
                        updateDebug('Ring.glb: OK');
                    } else {
                        updateDebug(`Ring.glb: HTTP ${response.status}`);
                    }
                })
                .catch(err => {
                    updateDebug(`Ring.glb: ${err.message}`);
                });
                
            fetch('targets.mind')
                .then(response => {
                    if (response.ok) {
                        updateDebug('targets.mind: OK');
                    } else {
                        updateDebug(`targets.mind: HTTP ${response.status}`);
                    }
                })
                .catch(err => {
                    updateDebug(`targets.mind: ${err.message}`);
                });
        }, 2000);
    </script>
</body>
</html>