<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Dichotomium Scanner v1.6.2</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            position: fixed;
            width: 100vw;
            height: 100vh;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        #ui {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .terminal {
            background: #111;
            border: 1px solid #0f0;
            padding: 25px;
            border-radius: 5px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }
        
        h1 {
            color: #0f0;
            margin-bottom: 10px;
            font-size: 22px;
        }
        
        #status {
            color: #0ff;
            margin: 15px 0;
            font-size: 16px;
            min-height: 20px;
        }
        
        #progress {
            width: 200px;
            height: 4px;
            background: #333;
            margin: 10px 0;
            border-radius: 2px;
            overflow: hidden;
        }
        
        #progress-bar {
            width: 0%;
            height: 100%;
            background: #0f0;
            transition: width 0.3s;
        }
        
        .scan-button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 15px 0;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }
        
        .scan-button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* –ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø AR: —Å—Ç–∏–ª–∏ –¥–ª—è canvas */
        .a-canvas {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            display: block !important;
            z-index: 0 !important;
            background-color: transparent !important;
        }
        
        a-scene {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 999 !important;
        }
        
        #version {
            position: fixed;
            bottom: 10px;
            right: 10px;
            color: #666;
            font-size: 11px;
            z-index: 1001;
        }
        
        #debug {
            position: fixed;
            bottom: 30px;
            left: 10px;
            color: #888;
            font-size: 10px;
            z-index: 1001;
            background: rgba(0,0,0,0.7);
            padding: 5px;
            border-radius: 3px;
            max-width: 200px;
        }
    </style>
</head>
<body>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
            Telegram.WebApp.expand();
            Telegram.WebApp.setHeaderColor('#000000');
            Telegram.WebApp.setBackgroundColor('#000000');
        }
    </script>

    <div id="ui">
        <div class="terminal">
            <h1>>> DICHOTOMIUM SYSTEM</h1>
            <div id="status">INITIALIZING SYSTEM...</div>
            <div id="progress">
                <div id="progress-bar"></div>
            </div>
            <button id="startBtn" class="scan-button" disabled>
                INITIALIZE SCANNER
            </button>
            <div style="color: #666; font-size: 12px; margin-top: 20px;">
                Loading AR system...
            </div>
        </div>
    </div>
    
    <div id="version">v1.6.2</div>
    <div id="debug">INIT: Starting...</div>
    
    <!-- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø AR –°–¶–ï–ù–ê -->
    <a-scene id="arScene"
             mindar-image="imageTargetSrc: targets.mind; 
                          autoStart: false;
                          filterMinCF: 0.001;
                          filterBeta: 0.1;
                          uiScanning: no;
                          uiLoading: no;
                          uiError: no"
             embedded
             renderer="antialias: true; alpha: true; logarithmicDepthBuffer: false; colorManagement: true; precision: mediump;"
             vr-mode-ui="enabled: false"
             device-orientation-permission-ui="enabled: false"
             class="hidden">
        
        <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º a-assets –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ -->
        <a-assets timeout="60000">
            <a-asset-item id="ring-model" src="Ring.glb"></a-asset-item>
        </a-assets>
        
        <a-camera position="0 0 0" look-controls="enabled: false" wasd-controls="enabled: false"></a-camera>
        
        <!-- –¶–µ–ª–µ–≤–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –º–æ–¥–µ–ª—å—é -->
        <a-entity mindar-image-target="targetIndex: 0">
            <a-entity gltf-model="#ring-model"
                      position="0 0 0"
                      rotation="0 0 0"
                      scale="0.1 0.1 0.1"
                      animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear"
                      shadow="receive: false">
            </a-entity>
        </a-entity>
        
        <!-- –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ -->
        <a-light type="ambient" color="#FFFFFF" intensity="0.7"></a-light>
        <a-light type="directional" position="1 2 1" intensity="0.5"></a-light>
    </a-scene>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const APP_VERSION = '1.6.2';
        const BUILD_DATE = '2024.01.15.7';
        document.getElementById('version').textContent = `v${APP_VERSION} (${BUILD_DATE})`;
        
        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        const ui = document.getElementById('ui');
        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const progressBar = document.getElementById('progress-bar');
        const debug = document.getElementById('debug');
        const arScene = document.getElementById('arScene');
        
        let arReady = false;
        let isTelegram = typeof Telegram !== 'undefined' && Telegram.WebApp;
        let mindarSystem = null;
        
        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        function updateDebug(msg) {
            debug.textContent = `DEBUG: ${msg}`;
            console.log(msg);
        }
        
        function updateProgress(percent, message) {
            progressBar.style.width = `${percent}%`;
            status.textContent = message;
            updateDebug(`${message} (${percent}%)`);
        }
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø AR –°–ò–°–¢–ï–ú–´ ==========
        function initAR() {
            updateProgress(30, 'Loading AR system...');
            
            // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ A-Frame
            if (typeof AFRAME === 'undefined') {
                updateDebug('Waiting for A-Frame...');
                setTimeout(initAR, 100);
                return;
            }
            
            updateProgress(50, 'A-Frame loaded');
            updateDebug(`A-Frame v${AFRAME.version} loaded`);
            
            // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ MindAR —Å–∏—Å—Ç–µ–º—ã
            const checkMindAR = () => {
                if (arScene.systems && arScene.systems['mindar-image-system']) {
                    mindarSystem = arScene.systems['mindar-image-system'];
                    updateProgress(100, 'System ready!');
                    arReady = true;
                    startBtn.disabled = false;
                    updateDebug('‚úÖ MindAR system ready');
                } else {
                    setTimeout(checkMindAR, 100);
                }
            };
            
            checkMindAR();
        }
        
        // ========== –ó–ê–ü–£–°–ö –°–ö–ê–ù–ï–†–ê ==========
        startBtn.addEventListener('click', async () => {
            if (!arReady) return;
            
            startBtn.disabled = true;
            status.textContent = 'Starting camera...';
            updateDebug('Starting AR scanner...');
            
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º AR
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ—Ç–æ–∫
                stream.getTracks().forEach(track => track.stop());
                
                updateDebug('Camera access granted');
                
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ AR —Ä–µ–∂–∏–º
                ui.classList.add('hidden');
                arScene.classList.remove('hidden');
                
                // –ö–†–ò–¢–ò–ß–ù–û: –î–∞–µ–º —Å—Ü–µ–Ω–µ –≤—Ä–µ–º—è –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º MindAR
                setTimeout(() => {
                    if (mindarSystem) {
                        mindarSystem.start();
                        updateDebug('AR scanner started');
                        
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ canvas –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ AR
                        setTimeout(() => {
                            const canvas = arScene.canvas;
                            if (canvas) {
                                canvas.style.cssText = `
                                    position: fixed !important;
                                    top: 0 !important;
                                    left: 0 !important;
                                    width: 100vw !important;
                                    height: 100vh !important;
                                    display: block !important;
                                    z-index: 0 !important;
                                `;
                                updateDebug('Canvas —Å—Ç–∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
                            }
                            
                            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
                            if (arScene.renderer) {
                                arScene.renderer.setSize(window.innerWidth, window.innerHeight);
                                arScene.render();
                            }
                        }, 100);
                        
                        // –¢–∞–∫—Ç–∏–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫ –≤ Telegram
                        if (isTelegram) {
                            try {
                                Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                                Telegram.WebApp.BackButton.show();
                            } catch (e) {
                                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π Telegram
                            }
                        }
                    }
                }, 500); // –£–≤–µ–ª–∏—á–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ü–µ–Ω—ã
                
            } catch (error) {
                console.error('Camera error:', error);
                updateDebug(`‚ùå Camera Error: ${error.name}`);
                status.textContent = `Camera Error: ${error.message || 'Access denied'}`;
                startBtn.disabled = false;
                
                if (isTelegram) {
                    Telegram.WebApp.showAlert('Please allow camera access to use the AR scanner.');
                }
            }
        });
        
        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô AR ==========
        arScene.addEventListener('arReady', () => {
            updateDebug('AR system ready for tracking');
        });
        
        arScene.addEventListener('targetFound', () => {
            updateDebug('üéØ Target found');
            if (isTelegram) {
                try {
                    Telegram.WebApp.HapticFeedback.impactOccurred('light');
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π Telegram
                }
            }
        });
        
        arScene.addEventListener('targetLost', () => {
            updateDebug('Target lost');
        });
        
        // ========== TELEGRAM WEBVIEW FIX ==========
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && mindarSystem && mindarSystem.active && !arScene.classList.contains('hidden')) {
                updateDebug('Page visible - restarting AR');
                setTimeout(() => {
                    if (mindarSystem.active) {
                        mindarSystem.stop();
                        setTimeout(() => {
                            mindarSystem.start();
                            // –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ–º canvas
                            setTimeout(() => {
                                const canvas = arScene.canvas;
                                if (canvas) {
                                    canvas.style.display = 'none';
                                    setTimeout(() => {
                                        canvas.style.display = 'block';
                                    }, 50);
                                }
                            }, 100);
                        }, 200);
                    }
                }, 300);
            }
        });
        
        // ========== –ö–ù–û–ü–ö–ê –ù–ê–ó–ê–î –í TELEGRAM ==========
        if (isTelegram) {
            Telegram.WebApp.BackButton.onClick(() => {
                if (!arScene.classList.contains('hidden')) {
                    if (mindarSystem && mindarSystem.active) {
                        mindarSystem.stop();
                    }
                    
                    arScene.classList.add('hidden');
                    ui.classList.remove('hidden');
                    try {
                        Telegram.WebApp.BackButton.hide();
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π
                    }
                    
                    updateDebug('Returned to menu');
                    startBtn.disabled = false;
                    status.textContent = 'System ready!';
                }
            });
        }
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        window.addEventListener('DOMContentLoaded', () => {
            updateDebug(`=== Dichotomium Scanner v${APP_VERSION} ===`);
            updateDebug(`Build: ${BUILD_DATE}`);
            updateDebug(`Platform: ${isTelegram ? 'Telegram' : 'Browser'}`);
            
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
            setTimeout(initAR, 500);
        });
        
        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', () => {
            if (mindarSystem && mindarSystem.active) {
                mindarSystem.stop();
            }
        });
    </script>
</body>
</html>