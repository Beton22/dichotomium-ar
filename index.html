<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AR Scanner</title>
    
    <!-- ВАРИАНТ 1: Официальные ссылки -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <!-- Пробуем разные CDN для MindAR -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-aframe.prod.js"></script>
    
    <!-- Резервный вариант -->
    <script src="https://unpkg.com/mind-ar@1.2.3/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }
        
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .terminal {
            background: #111;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #0f0;
            max-width: 400px;
            margin: 20px;
        }
        
        .terminal-line {
            margin: 5px 0;
            color: #0f0;
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 12px 24px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            border-radius: 3px;
        }
        
        button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
        
        #status {
            color: #ff0;
        }
        
        #error {
            color: #f00;
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255,0,0,0.1);
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="loader">
        <div class="terminal">
            <div class="terminal-line">>>> SYSTEM BOOT</div>
            <div class="terminal-line">>>> INITIALIZING AR CORE</div>
            <div class="terminal-line">>>> LOADING MODULES...</div>
            <div class="terminal-line">>>> STATUS: <span id="status">LOADING</span></div>
            <div class="terminal-line blink" id="progress">...</div>
            <div id="error"></div>
            
            <button id="start-btn" disabled>INITIALIZE SCANNER</button>
            <div style="margin-top: 10px; font-size: 12px; color: #888;">
                Если кнопка не активируется, перезагрузите страницу
            </div>
        </div>
    </div>

    <a-scene 
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        embedded
        id="ar-scene"
        style="width: 100%; height: 100vh;"
    >
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        
        <!-- Простой куб для теста -->
        <a-box position="0 0 -1" rotation="0 45 0" color="#4CC3D9" scale="0.5 0.5 0.5"></a-box>
        <a-sky color="#ECECEC"></a-sky>
    </a-scene>

    <script>
        console.log("=== AR SYSTEM INIT ===");
        
        // Элементы
        const loader = document.getElementById('loader');
        const status = document.getElementById('status');
        const progress = document.getElementById('progress');
        const startBtn = document.getElementById('start-btn');
        const errorDiv = document.getElementById('error');
        const sceneEl = document.getElementById('ar-scene');
        
        let checkCount = 0;
        const maxChecks = 30; // 30 попыток по 1 секунде = 30 секунд максимум
        
        // Функция проверки загрузки библиотек
        function checkLibrariesLoaded() {
            checkCount++;
            progress.textContent = '.'.repeat(checkCount % 4) + ' '.repeat(3 - (checkCount % 4));
            
            console.log(`Check ${checkCount}: AFRAME=${typeof AFRAME}, MindAR system=${AFRAME && AFRAME.systems ? 'exists' : 'no'}`);
            
            // Проверяем A-Frame
            if (typeof AFRAME === 'undefined') {
                status.textContent = "WAITING FOR A-FRAME";
                if (checkCount < maxChecks) {
                    setTimeout(checkLibrariesLoaded, 1000);
                } else {
                    showError("A-Frame не загрузился. Проверьте интернет соединение.");
                }
                return;
            }
            
            // Проверяем MindAR
            if (!AFRAME.systems || !AFRAME.systems['mindar-image-system']) {
                status.textContent = "LOADING MINDAR";
                if (checkCount < maxChecks) {
                    setTimeout(checkLibrariesLoaded, 1000);
                } else {
                    showError("MindAR не загрузился. Попробуйте другой браузер или устройство.");
                }
                return;
            }
            
            // Все загружено!
            console.log("Все библиотеки загружены!");
            status.textContent = "READY";
            progress.textContent = ">>> SYSTEMS NOMINAL";
            startBtn.disabled = false;
            startBtn.textContent = "ACTIVATE SCANNER";
            startBtn.style.background = "#0f0";
            
            // Инициализируем MindAR сценарий ДО запуска
            initializeMindAR();
        }
        
        // Инициализация MindAR
        function initializeMindAR() {
            try {
                console.log("Инициализация MindAR...");
                
                // Удаляем старую сцену
                const oldScene = document.querySelector('a-scene');
                if (oldScene && oldScene.parentNode) {
                    oldScene.parentNode.removeChild(oldScene);
                }
                
                // Создаем новую сцену с MindAR
                const newScene = document.createElement('a-scene');
                newScene.id = 'ar-scene';
                newScene.style.width = '100%';
                newScene.style.height = '100vh';
                newScene.setAttribute('vr-mode-ui', 'enabled: false');
                newScene.setAttribute('device-orientation-permission-ui', 'enabled: false');
                newScene.setAttribute('embedded', '');
                
                // Добавляем атрибут MindAR с таймаутами
                newScene.setAttribute('mindar-image', JSON.stringify({
                    imageTargetSrc: 'targets.mind',
                    autoStart: false,
                    uiLoading: 'no',
                    uiScanning: 'no',
                    filterMinCF: 0.001,
                    filterBeta: 0.01,
                    missTolerance: 10
                }));
                
                // Камера
                const camera = document.createElement('a-camera');
                camera.setAttribute('position', '0 0 0');
                camera.setAttribute('look-controls', 'enabled: false');
                newScene.appendChild(camera);
                
                // Тестовый объект
                const targetEntity = document.createElement('a-entity');
                targetEntity.setAttribute('mindar-image-target', 'targetIndex: 0');
                
                const testBox = document.createElement('a-box');
                testBox.setAttribute('position', '0 0 0');
                testBox.setAttribute('color', '#00ff00');
                testBox.setAttribute('scale', '0.2 0.2 0.2');
                testBox.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 10000');
                
                targetEntity.appendChild(testBox);
                newScene.appendChild(targetEntity);
                
                // Добавляем на страницу
                document.body.appendChild(newScene);
                
                // Обновляем ссылку на сцену
                window.sceneEl = newScene;
                
                console.log("MindAR сцена создана");
                
            } catch (error) {
                console.error("Ошибка при создании сцены:", error);
                showError("Ошибка конфигурации: " + error.message);
            }
        }
        
        // Обработчик кнопки запуска
        startBtn.addEventListener('click', async function() {
            console.log("Запуск сканера...");
            status.textContent = "STARTING...";
            startBtn.disabled = true;
            
            try {
                // Проверяем доступ к камере
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment'
                    } 
                });
                
                // Останавливаем тестовый поток
                stream.getTracks().forEach(track => track.stop());
                
                // Запускаем MindAR
                if (window.sceneEl && window.sceneEl.systems['mindar-image-system']) {
                    window.sceneEl.systems['mindar-image-system'].start();
                    loader.style.display = 'none';
                    console.log("AR запущен!");
                } else {
                    throw new Error("AR система не найдена");
                }
                
            } catch (error) {
                console.error("Ошибка запуска:", error);
                
                if (error.name === 'NotAllowedError') {
                    showError("Доступ к камере запрещен. Разрешите камеру в настройках браузера.");
                } else if (error.name === 'NotFoundError') {
                    showError("Камера не найдена. Убедитесь, что устройство имеет камеру.");
                } else if (error.name === 'NotSupportedError') {
                    showError("AR не поддерживается вашим браузером. Попробуйте Chrome или Edge.");
                } else {
                    showError("Ошибка: " + error.message);
                }
                
                startBtn.disabled = false;
                status.textContent = "ERROR";
            }
        });
        
        // Показать ошибку
        function showError(message) {
            console.error(message);
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            status.textContent = "ERROR";
            progress.textContent = ">>> SYSTEM FAILURE";
        }
        
        // Начать проверку через 2 секунды (даем время на загрузку)
        setTimeout(() => {
            console.log("Начинаем проверку библиотек...");
            checkLibrariesLoaded();
        }, 2000);
        
        // Альтернативный запуск при полной загрузке страницы
        window.addEventListener('load', function() {
            console.log("Страница полностью загружена");
        });
        
        // Если что-то пошло не так, даем возможность перезагрузить
        window.addEventListener('error', function(e) {
            console.error("Глобальная ошибка:", e.error);
        });
    </script>
</body>
</html>