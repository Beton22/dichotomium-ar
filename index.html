<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Scanner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <!-- MindAR –ª–æ–∫–∞–ª—å–Ω–æ -->
    <script src="mindar-image-aframe.prod.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #000; 
            color: #0f0; 
            font-family: 'Courier New', monospace;
            width: 100vw; 
            height: 100vh; 
            overflow: hidden;
        }
        
        #loader {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        .console {
            background: rgba(20, 20, 20, 0.9);
            border: 2px solid #0f0;
            border-radius: 8px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        
        .status-line {
            margin: 8px 0;
            color: #0f0;
            font-size: 16px;
        }
        
        .blink {
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        button {
            background: linear-gradient(135deg, #0f0, #0a0);
            color: #000;
            border: none;
            padding: 18px 40px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 30px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }
        
        button:hover {
            background: linear-gradient(135deg, #0f0, #0f0);
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(0, 255, 0, 0.8);
        }
        
        button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        
        #error {
            color: #f00;
            background: rgba(255, 0, 0, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border: 1px solid #f00;
            display: none;
        }
        
        #camera-feed {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: 900;
            display: none;
        }
        
        #debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 12px;
            color: #888;
            background: rgba(0,0,0,0.7);
            padding: 8px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- –¢–µ—Å—Ç–æ–≤—ã–π –≤–∏–¥–µ–æ—ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∫–∞–º–µ—Ä—ã -->
    <video id="camera-feed" autoplay playsinline muted></video>
    
    <div id="loader">
        <div class="console">
            <h2 style="color: #0f0; margin-bottom: 20px;">üß¨ AR SCANNER SYSTEM</h2>
            
            <div class="status-line">>>> System Boot Sequence</div>
            <div class="status-line">>>> Loading Core Modules...</div>
            <div class="status-line">>>> A-Frame Status: <span id="aframe-status">WAITING...</span></div>
            <div class="status-line">>>> MindAR Status: <span id="mindar-status">WAITING...</span></div>
            <div class="status-line">>>> Camera Status: <span id="camera-status">READY</span></div>
            <div class="status-line blink" id="main-status">>>> AWAITING USER INPUT</div>
            
            <button id="start-btn" onclick="initAR()">üéÆ INITIALIZE AR</button>
            
            <div id="error"></div>
            
            <div style="margin-top: 30px; font-size: 14px; color: #888;">
                <div>Device: <span id="device-info">Detecting...</span></div>
                <div>Browser: <span id="browser-info">Detecting...</span></div>
            </div>
        </div>
    </div>
    
    <div id="debug-info">
        Console: <span id="console-status">Initializing...</span>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è AR —Å—Ü–µ–Ω—ã -->
    <div id="ar-container" style="position:fixed; top:0; left:0; width:100%; height:100%;"></div>

    <!-- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π A-Frame -->
    <script>
        // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è A-Frame –¥–ª—è –∑–∞–ø—É—Å–∫–∞
        console.log("‚ö° Initializing A-Frame...");
        window.AFRAME = window.AFRAME || {
            version: '1.4.0-mini',
            components: {},
            systems: {},
            scenes: [],
            registerComponent: function(name, def) {
                this.components[name] = def;
                console.log("Component registered:", name);
            },
            registerSystem: function(name, def) {
                this.systems[name] = { 
                    ...def,
                    start: function() {
                        console.log("System started:", name);
                        if (def.start) def.start.call(this);
                    }
                };
                console.log("System registered:", name);
            }
        };
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ –±—Ä–∞—É–∑–µ—Ä
        document.getElementById('device-info').textContent = navigator.platform || 'Unknown';
        document.getElementById('browser-info').textContent = navigator.userAgent.substring(0, 50) + '...';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É MindAR
        function checkMindAR() {
            console.log("üîç Checking MindAR...");
            
            if (window.AFRAME && AFRAME.systems && AFRAME.systems['mindar-image-system']) {
                console.log("‚úÖ MindAR system found!");
                document.getElementById('mindar-status').innerHTML = '<span style="color:#0f0">‚úÖ LOADED</span>';
                document.getElementById('aframe-status').innerHTML = '<span style="color:#0f0">‚úÖ READY</span>';
                document.getElementById('main-status').textContent = '>>> SYSTEM READY';
                document.getElementById('console-status').textContent = 'Systems loaded';
                return true;
            } else {
                console.log("‚è≥ MindAR not yet loaded...");
                setTimeout(checkMindAR, 1000);
                return false;
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
        setTimeout(checkMindAR, 1000);
        
        // –¢–µ—Å—Ç –∫–∞–º–µ—Ä—ã –±–µ–∑ AR
        async function testCamera() {
            console.log("üì∑ Testing camera...");
            document.getElementById('camera-status').innerHTML = '<span style="color:#ff0">TESTING...</span>';
            
            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω—É—é –∫–∞–º–µ—Ä—É
                const testStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'user',  // —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: false
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ
                const video = document.getElementById('camera-feed');
                video.srcObject = testStream;
                video.style.display = 'block';
                
                console.log("‚úÖ Front camera works!");
                document.getElementById('camera-status').innerHTML = '<span style="color:#0f0">‚úÖ FRONT CAMERA OK</span>';
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ—Ç–æ–∫ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    testStream.getTracks().forEach(track => track.stop());
                    video.style.display = 'none';
                    video.srcObject = null;
                    document.getElementById('camera-status').innerHTML = '<span style="color:#0f0">‚úÖ TEST PASSED</span>';
                }, 2000);
                
                return true;
                
            } catch (err) {
                console.error("‚ùå Camera test failed:", err);
                document.getElementById('camera-status').innerHTML = '<span style="color:#f00">‚ùå TEST FAILED</span>';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω—É—é –æ—à–∏–±–∫—É
                let errorMsg = "Camera Error: ";
                if (err.name === 'NotAllowedError') {
                    errorMsg = "üìµ Camera access denied. Please allow camera access in browser settings.";
                } else if (err.name === 'NotFoundError') {
                    errorMsg = "üì∑ No camera found on this device.";
                } else if (err.name === 'NotReadableError') {
                    errorMsg = "‚ö†Ô∏è Camera is already in use by another application.";
                } else {
                    errorMsg = "‚ùå Unknown camera error: " + err.message;
                }
                
                document.getElementById('error').innerHTML = errorMsg;
                document.getElementById('error').style.display = 'block';
                return false;
            }
        }
        
        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ AR
        async function initAR() {
            console.log("üöÄ Starting AR initialization...");
            
            const startBtn = document.getElementById('start-btn');
            const mainStatus = document.getElementById('main-status');
            const errorDiv = document.getElementById('error');
            
            // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å
            startBtn.disabled = true;
            startBtn.textContent = '‚è≥ INITIALIZING...';
            mainStatus.textContent = '>>> CHECKING PERMISSIONS...';
            errorDiv.style.display = 'none';
            
            // 1. –°–Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É
            const cameraTest = await testCamera();
            if (!cameraTest) {
                startBtn.disabled = false;
                startBtn.textContent = 'üîÑ RETRY CAMERA';
                return;
            }
            
            // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º MindAR
            if (!AFRAME.systems['mindar-image-system']) {
                mainStatus.textContent = '>>> ERROR: MINDAR NOT LOADED';
                errorDiv.innerHTML = "MindAR system not found. Please reload the page.";
                errorDiv.style.display = 'block';
                startBtn.disabled = false;
                startBtn.textContent = 'üîÑ RELOAD PAGE';
                return;
            }
            
            // 3. –°–æ–∑–¥–∞–µ–º AR —Å—Ü–µ–Ω—É
            mainStatus.textContent = '>>> CREATING AR ENVIRONMENT...';
            console.log("Creating AR scene...");
            
            try {
                // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                document.getElementById('ar-container').innerHTML = '';
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ü–µ–Ω—É
                const scene = document.createElement('a-scene');
                scene.setAttribute('mindar-image', `
                    imageTargetSrc: targets.mind;
                    autoStart: false;
                    uiScanning: no;
                    uiLoading: no;
                    maxTrack: 2;
                `);
                scene.setAttribute('vr-mode-ui', 'enabled: false');
                scene.setAttribute('device-orientation-permission-ui', 'enabled: false');
                scene.setAttribute('embedded', '');
                scene.style.width = '100%';
                scene.style.height = '100%';
                scene.style.position = 'absolute';
                scene.style.top = '0';
                scene.style.left = '0';
                
                // –ö–∞–º–µ—Ä–∞ AR
                const camera = document.createElement('a-camera');
                camera.setAttribute('position', '0 0 0');
                camera.setAttribute('look-controls', 'enabled: false');
                scene.appendChild(camera);
                
                // –¢–µ—Å—Ç–æ–≤—ã–π –æ–±—ä–µ–∫—Ç (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ targets.mind –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
                const targetEntity = document.createElement('a-entity');
                targetEntity.setAttribute('mindar-image-target', 'targetIndex: 0');
                
                const testObject = document.createElement('a-box');
                testObject.setAttribute('position', '0 0 0');
                testObject.setAttribute('color', '#00ff00');
                testObject.setAttribute('scale', '0.15 0.15 0.15');
                testObject.setAttribute('animation', `
                    property: rotation;
                    to: 0 360 0;
                    loop: true;
                    dur: 8000;
                    easing: linear
                `);
                
                targetEntity.appendChild(testObject);
                scene.appendChild(targetEntity);
                
                // –û—Å–≤–µ—â–µ–Ω–∏–µ
                const ambientLight = document.createElement('a-light');
                ambientLight.setAttribute('type', 'ambient');
                ambientLight.setAttribute('color', '#ffffff');
                ambientLight.setAttribute('intensity', '0.6');
                scene.appendChild(ambientLight);
                
                const directionalLight = document.createElement('a-light');
                directionalLight.setAttribute('type', 'directional');
                directionalLight.setAttribute('position', '2 5 3');
                directionalLight.setAttribute('intensity', '0.5');
                directionalLight.setAttribute('cast-shadow', '');
                scene.appendChild(directionalLight);
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ü–µ–Ω—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
                document.getElementById('ar-container').appendChild(scene);
                
                // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ü–µ–Ω—ã
                scene.addEventListener('loaded', function() {
                    console.log("‚úÖ AR scene loaded");
                    mainStatus.textContent = '>>> STARTING AR...';
                    
                    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É –¥–ª—è AR
                    navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment',  // –∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    })
                    .then(function(stream) {
                        console.log("‚úÖ Rear camera access granted");
                        
                        // –ó–∞–ø—É—Å–∫–∞–µ–º MindAR —Å–∏—Å—Ç–µ–º—É
                        const mindarSystem = scene.systems['mindar-image-system'];
                        if (mindarSystem && mindarSystem.start) {
                            mindarSystem.start();
                            
                            // –°–∫—Ä—ã–≤–∞–µ–º loader —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                            setTimeout(function() {
                                document.getElementById('loader').style.display = 'none';
                                console.log("üéâ AR system started successfully!");
                                mainStatus.textContent = '>>> AR ACTIVE';
                            }, 1000);
                            
                        } else {
                            throw new Error("MindAR start method not found");
                        }
                        
                        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ—Ç–æ–∫
                        stream.getTracks().forEach(track => track.stop());
                        
                    })
                    .catch(function(err) {
                        console.error("‚ùå Rear camera error:", err);
                        
                        // –ü—Ä–æ–±—É–µ–º —Å —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π –∫–∞–º–µ—Ä–æ–π –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                        navigator.mediaDevices.getUserMedia({
                            video: { facingMode: 'user' }
                        })
                        .then(function(fallbackStream) {
                            console.log("‚úÖ Using front camera as fallback");
                            const mindarSystem = scene.systems['mindar-image-system'];
                            if (mindarSystem) mindarSystem.start();
                            
                            setTimeout(function() {
                                document.getElementById('loader').style.display = 'none';
                            }, 1000);
                            
                            fallbackStream.getTracks().forEach(track => track.stop());
                        })
                        .catch(function(fallbackErr) {
                            console.error("‚ùå All camera access failed:", fallbackErr);
                            showError("Cannot access any camera: " + fallbackErr.message);
                            startBtn.disabled = false;
                            startBtn.textContent = 'üîÑ RETRY';
                        });
                    });
                });
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å—Ü–µ–Ω—ã
                scene.addEventListener('arError', function(event) {
                    console.error("AR Error:", event.detail.error);
                    showError("AR System Error: " + event.detail.error);
                });
                
                // –°–æ–±—ã—Ç–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞
                scene.addEventListener('targetFound', function() {
                    console.log("üéØ Target found!");
                    mainStatus.textContent = '>>> TARGET ACQUIRED';
                    mainStatus.style.color = '#0ff';
                });
                
                scene.addEventListener('targetLost', function() {
                    mainStatus.textContent = '>>> SCANNING...';
                    mainStatus.style.color = '#0f0';
                });
                
            } catch (error) {
                console.error("‚ùå Scene creation error:", error);
                showError("Failed to create AR scene: " + error.message);
                startBtn.disabled = false;
                startBtn.textContent = 'üîÑ RETRY';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–æ–∫
        function showError(message) {
            console.error("Error:", message);
            document.getElementById('error').innerHTML = message;
            document.getElementById('error').style.display = 'block';
            document.getElementById('main-status').textContent = '>>> ERROR';
            document.getElementById('main-status').style.color = '#f00';
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –∫–∞–º–µ—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', function() {
            console.log("üìÑ Page fully loaded");
            document.getElementById('console-status').textContent = 'Page loaded';
            
            // –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–º–µ—Ä—É
            setTimeout(function() {
                if (!document.getElementById('error').style.display) {
                    console.log("Offering camera test...");
                    document.getElementById('main-status').textContent = '>>> CLICK BUTTON TO START';
                }
            }, 3000);
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
        window.addEventListener('error', function(event) {
            console.error("Global error:", event.error);
            document.getElementById('console-status').textContent = 'Error: ' + event.message;
        });
    </script>
</body>
</html>