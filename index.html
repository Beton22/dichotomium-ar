<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AR Scanner</title>
    
    <!-- –õ–û–ö–ê–õ–¨–ù–´–ï –°–ö–†–ò–ü–¢–´ -->
    <script src="aframe.min.js"></script>
    <script src="mindar-image-aframe.prod.js"></script>
    
    <style>
        * { margin: 0; padding: 0; }
        body { 
            font-family: monospace; 
            background: black; 
            color: lime; 
            overflow: hidden;
        }
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0,0,0,0.9);
            padding: 30px;
            border: 2px solid lime;
            border-radius: 10px;
            z-index: 1000;
        }
        #error {
            color: red;
            margin-top: 20px;
            display: none;
        }
        button {
            background: lime;
            color: black;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            margin-top: 20px;
            cursor: pointer;
            font-family: monospace;
            font-weight: bold;
        }
        button:disabled {
            background: gray;
            cursor: not-allowed;
        }
        #log {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div id="log">
        <div>Status: <span id="status">Loading...</span></div>
        <div>AFrame: <span id="aframe-status">‚ùå</span></div>
        <div>MindAR: <span id="mindar-status">‚ùå</span></div>
    </div>
    
    <div id="loading">
        <h2>üß¨ AR SCANNER v1.0</h2>
        <p id="message">Initializing system...</p>
        <button id="start-btn" disabled>ACTIVATE SCANNER</button>
        <div id="error"></div>
        <p style="margin-top: 20px; font-size: 12px; color: #888;">
            beton22.github.io
        </p>
    </div>

    <!-- –°—Ü–µ–Ω–∞ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    <div id="scene-container"></div>

    <script>
        console.log("=== SYSTEM BOOT ===");
        
        const logs = [];
        function log(msg) {
            console.log(msg);
            logs.push(msg);
            if(logs.length > 10) logs.shift();
        }
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const loadingEl = document.getElementById('loading');
        const startBtn = document.getElementById('start-btn');
        const messageEl = document.getElementById('message');
        const errorEl = document.getElementById('error');
        const statusEl = document.getElementById('status');
        const aframeStatus = document.getElementById('aframe-status');
        const mindarStatus = document.getElementById('mindar-status');
        const sceneContainer = document.getElementById('scene-container');
        
        let mindarSystem = null;
        
        // –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º A-Frame
        function checkAFrame() {
            if (typeof AFRAME === 'undefined') {
                messageEl.textContent = "A-Frame not loaded. Retrying...";
                aframeStatus.textContent = "‚ùå";
                setTimeout(checkAFrame, 1000);
                return;
            }
            
            log("‚úÖ A-Frame loaded: v" + AFRAME.version);
            aframeStatus.textContent = "‚úÖ v" + AFRAME.version;
            
            // –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º MindAR
            checkMindAR();
        }
        
        // –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º MindAR
        function checkMindAR() {
            if (!AFRAME.systems || !AFRAME.systems['mindar-image-system']) {
                messageEl.textContent = "MindAR loading...";
                mindarStatus.textContent = "‚åõ";
                setTimeout(checkMindAR, 1000);
                return;
            }
            
            log("‚úÖ MindAR system detected");
            mindarStatus.textContent = "‚úÖ";
            
            // –®–∞–≥ 3: –°–æ–∑–¥–∞–µ–º —Å—Ü–µ–Ω—É
            createScene();
        }
        
        // –®–∞–≥ 3: –°–æ–∑–¥–∞–µ–º AR —Å—Ü–µ–Ω—É
        function createScene() {
            try {
                messageEl.textContent = "Creating AR environment...";
                statusEl.textContent = "Creating scene";
                
                // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                sceneContainer.innerHTML = '';
                
                // –°–æ–∑–¥–∞–µ–º —Å—Ü–µ–Ω—É —Å MindAR
                const scene = document.createElement('a-scene');
                scene.id = 'ar-scene';
                scene.setAttribute('mindar-image', 
                    `imageTargetSrc: targets.mind; 
                     autoStart: false;
                     uiScanning: no;
                     uiLoading: no;`
                );
                scene.setAttribute('vr-mode-ui', 'enabled: false');
                scene.setAttribute('device-orientation-permission-ui', 'enabled: false');
                scene.setAttribute('embedded', '');
                scene.style.width = '100%';
                scene.style.height = '100vh';
                scene.style.position = 'fixed';
                scene.style.top = '0';
                scene.style.left = '0';
                
                // –ö–∞–º–µ—Ä–∞
                const camera = document.createElement('a-camera');
                camera.setAttribute('position', '0 0 0');
                camera.setAttribute('look-controls', 'enabled: false');
                scene.appendChild(camera);
                
                // –¢–µ—Å—Ç–æ–≤—ã–π –æ–±—ä–µ–∫—Ç (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ targets.mind –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è)
                const testTarget = document.createElement('a-entity');
                testTarget.setAttribute('mindar-image-target', 'targetIndex: 0');
                
                const box = document.createElement('a-box');
                box.setAttribute('position', '0 0 0');
                box.setAttribute('color', 'lime');
                box.setAttribute('scale', '0.1 0.1 0.1');
                box.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 5000');
                
                testTarget.appendChild(box);
                scene.appendChild(testTarget);
                
                // –°–≤–µ—Ç
                const light1 = document.createElement('a-light');
                light1.setAttribute('type', 'ambient');
                light1.setAttribute('color', '#fff');
                light1.setAttribute('intensity', '0.6');
                scene.appendChild(light1);
                
                const light2 = document.createElement('a-light');
                light2.setAttribute('type', 'directional');
                light2.setAttribute('position', '1 1 1');
                light2.setAttribute('intensity', '0.4');
                scene.appendChild(light2);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
                sceneContainer.appendChild(scene);
                
                // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ü–µ–Ω—ã
                scene.addEventListener('loaded', function() {
                    log("‚úÖ Scene loaded");
                    mindarSystem = scene.systems['mindar-image-system'];
                    
                    if (mindarSystem) {
                        messageEl.textContent = "System ready!";
                        statusEl.textContent = "Ready";
                        startBtn.disabled = false;
                        startBtn.textContent = "üé• ACTIVATE SCANNER";
                        log("‚úÖ MindAR system initialized");
                    } else {
                        showError("MindAR system not found in scene");
                    }
                });
                
                scene.addEventListener('arReady', () => {
                    log("AR system ready");
                });
                
                scene.addEventListener('arError', (e) => {
                    log("AR Error: " + e.detail.error);
                    showError("AR Error: " + e.detail.error);
                });
                
            } catch (error) {
                showError("Create scene error: " + error.message);
            }
        }
        
        // –®–∞–≥ 4: –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
        startBtn.addEventListener('click', async function() {
            messageEl.textContent = "Requesting camera access...";
            startBtn.disabled = true;
            startBtn.textContent = "‚è≥ INITIALIZING...";
            
            try {
                // –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ—Ç–æ–∫
                stream.getTracks().forEach(track => track.stop());
                
                log("‚úÖ Camera access granted");
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º MindAR
                if (mindarSystem) {
                    mindarSystem.start();
                    loadingEl.style.display = 'none';
                    log("‚úÖ AR started successfully");
                } else {
                    throw new Error("AR system not available");
                }
                
            } catch (error) {
                console.error("Camera error:", error);
                
                if (error.name === 'NotAllowedError') {
                    showError("Camera permission denied. Please allow camera access.");
                } else if (error.name === 'NotFoundError') {
                    showError("No camera found on this device.");
                } else if (error.name === 'NotSupportedError') {
                    showError("AR not supported in this browser. Try Chrome.");
                } else {
                    showError("Error: " + error.message);
                }
                
                startBtn.disabled = false;
                startBtn.textContent = "üîÑ RETRY";
            }
        });
        
        function showError(msg) {
            console.error(msg);
            errorEl.textContent = msg;
            errorEl.style.display = 'block';
            statusEl.textContent = "Error";
            messageEl.textContent = "System error occurred";
        }
        
        // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
        setTimeout(checkAFrame, 100);
        
        // –ï—Å–ª–∏ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
        setTimeout(() => {
            if (startBtn.disabled) {
                showError("Loading timeout. Check if scripts are downloaded.");
                startBtn.disabled = false;
                startBtn.textContent = "üîÑ RETRY LOADING";
                startBtn.onclick = () => location.reload();
            }
        }, 10000);
    </script>
</body>
</html>