<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Scanner - Fixed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã -->
    <script src="aframe.min.js"></script>
    <script src="mindar-image-aframe.prod.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #0f0;
            font-family: monospace;
            overflow: hidden;
        }
        
        #startScreen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .console {
            background: #111;
            border: 2px solid #0f0;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 500px;
        }
        
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
        
        #status {
            margin: 15px 0;
            color: #0ff;
        }
        
        #error {
            color: #f00;
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,0,0,0.1);
            border-radius: 5px;
            display: none;
        }
        
        #trackingInfo {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            color: #0f0;
            z-index: 1001;
            display: none;
        }
        
        .hidden {
            display: none !important;
        }
        
        #debug {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: #888;
            padding: 5px;
            font-size: 12px;
            border-radius: 3px;
            z-index: 1002;
        }
    </style>
</head>
<body>
    <div id="startScreen">
        <div class="console">
            <h1>üß¨ AR SCANNER</h1>
            <div id="status">Loading AR system...</div>
            <button id="startBtn" onclick="startAR()" disabled>INITIALIZE SCANNER</button>
            <div id="error"></div>
            <div style="margin-top: 20px; color: #888; font-size: 12px;">
                Local build | No CDN required
            </div>
        </div>
    </div>
    
    <div id="trackingInfo">
        Status: <span id="trackingStatus">INACTIVE</span>
    </div>
    
    <div id="debug">
        Debug: <span id="debugText">Initializing</span>
    </div>
    
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è AR —Å—Ü–µ–Ω—ã -->
    <div id="arContainer"></div>

    <script>
        console.log("=== AR System Initialization ===");
        
        const startScreen = document.getElementById('startScreen');
        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const errorDiv = document.getElementById('error');
        const trackingInfo = document.getElementById('trackingInfo');
        const trackingStatus = document.getElementById('trackingStatus');
        const debugText = document.getElementById('debugText');
        const arContainer = document.getElementById('arContainer');
        
        let arScene = null;
        let mindarSystem = null;
        let checkCount = 0;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫
        function checkLibraries() {
            checkCount++;
            debugText.textContent = `Check ${checkCount}`;
            
            if (typeof AFRAME === 'undefined') {
                status.textContent = `Loading A-Frame...`;
                if (checkCount < 30) {
                    setTimeout(checkLibraries, 500);
                } else {
                    showError("A-Frame failed to load");
                }
                return;
            }
            
            console.log("‚úÖ A-Frame loaded:", AFRAME.version);
            status.textContent = "A-Frame loaded, checking MindAR...";
            
            if (!AFRAME.systems || !AFRAME.systems['mindar-image-system']) {
                status.textContent = `Loading MindAR...`;
                if (checkCount < 30) {
                    setTimeout(checkLibraries, 500);
                } else {
                    showError("MindAR failed to load");
                }
                return;
            }
            
            console.log("‚úÖ MindAR system found");
            status.textContent = "System ready!";
            startBtn.disabled = false;
            debugText.textContent = "Libraries loaded";
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            console.error(message);
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            status.textContent = "Error";
            debugText.textContent = "Error: " + message.substring(0, 30);
        }
        
        // –ó–∞–ø—É—Å–∫ AR
        async function startAR() {
            console.log("üöÄ Starting AR...");
            status.textContent = "Requesting camera...";
            startBtn.disabled = true;
            debugText.textContent = "Requesting camera";
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–º–µ—Ä—É
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                stream.getTracks().forEach(track => track.stop());
                console.log("‚úÖ Camera access granted");
                status.textContent = "Creating AR scene...";
                debugText.textContent = "Creating scene";
                
                // –°–æ–∑–¥–∞–µ–º AR —Å—Ü–µ–Ω—É
                createARScene();
                
            } catch (err) {
                console.error("Camera error:", err);
                let errorMsg = "Camera error: ";
                if (err.name === 'NotAllowedError') {
                    errorMsg = "Please allow camera access in browser settings";
                } else if (err.name === 'NotFoundError') {
                    errorMsg = "No camera found on this device";
                } else {
                    errorMsg += err.message;
                }
                showError(errorMsg);
                startBtn.disabled = false;
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ AR —Å—Ü–µ–Ω—ã
        function createARScene() {
            console.log("Creating AR scene...");
            
            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            arContainer.innerHTML = '';
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ü–µ–Ω—É
            arScene = document.createElement('a-scene');
            
            // –ù–ê–°–¢–†–û–ô–ö–ò MINDAR
            const mindarConfig = {
                imageTargetSrc: 'targets.mind',
                autoStart: false,  // –ù–ï –∑–∞–ø—É—Å–∫–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                filterMinCF: 0.01,
                filterBeta: 1000,
                missTolerance: 0,
                warmupTolerance: 0,
                maxTrack: 1
            };
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞—Ç—Ä–∏–±—É—Ç mindar-image
            arScene.setAttribute('mindar-image', `
                imageTargetSrc: ${mindarConfig.imageTargetSrc};
                autoStart: ${mindarConfig.autoStart};
                filterMinCF: ${mindarConfig.filterMinCF};
                filterBeta: ${mindarConfig.filterBeta};
                missTolerance: ${mindarConfig.missTolerance};
                warmupTolerance: ${mindarConfig.warmupTolerance};
                maxTrack: ${mindarConfig.maxTrack};
                uiLoading: #startScreen;
                uiScanning: #trackingInfo;
            `);
            
            arScene.setAttribute('vr-mode-ui', 'enabled: false');
            arScene.setAttribute('device-orientation-permission-ui', 'enabled: false');
            arScene.setAttribute('embedded', '');
            
            // –ö–∞–º–µ—Ä–∞
            const camera = document.createElement('a-camera');
            camera.setAttribute('position', '0 0 0');
            camera.setAttribute('look-controls', 'enabled: false');
            arScene.appendChild(camera);
            
            // –¢–∞—Ä–≥–µ—Ç —Å –º–æ–¥–µ–ª—å—é
            const target = document.createElement('a-entity');
            target.setAttribute('mindar-image-target', 'targetIndex: 0');
            
            // –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –∫—É–± –¥–ª—è —Ç–µ—Å—Ç–∞
            const testObject = document.createElement('a-box');
            testObject.setAttribute('position', '0 0 0');
            testObject.setAttribute('color', '#00ff00');
            testObject.setAttribute('scale', '0.2 0.2 0.2');
            testObject.setAttribute('animation', {
                property: 'rotation',
                to: '0 360 0',
                loop: true,
                dur: 10000,
                easing: 'linear'
            });
            
            target.appendChild(testObject);
            arScene.appendChild(target);
            
            // –û—Å–≤–µ—â–µ–Ω–∏–µ
            const ambientLight = document.createElement('a-light');
            ambientLight.setAttribute('type', 'ambient');
            ambientLight.setAttribute('color', '#FFF');
            ambientLight.setAttribute('intensity', '0.6');
            arScene.appendChild(ambientLight);
            
            const directionalLight = document.createElement('a-light');
            directionalLight.setAttribute('type', 'directional');
            directionalLight.setAttribute('position', '1 1 1');
            directionalLight.setAttribute('intensity', '0.4');
            arScene.appendChild(directionalLight);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ü–µ–Ω—É –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            arContainer.appendChild(arScene);
            
            // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è –î–û –∑–∞–ø—É—Å–∫–∞
            arScene.addEventListener('loaded', onSceneLoaded);
            arScene.addEventListener('arReady', onARReady);
            arScene.addEventListener('arError', onARError);
            arScene.addEventListener('targetFound', onTargetFound);
            arScene.addEventListener('targetLost', onTargetLost);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ü–µ–Ω—É
            startScreen.classList.add('hidden');
            trackingInfo.style.display = 'block';
            debugText.textContent = "Scene created";
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        function onSceneLoaded() {
            console.log("‚úÖ Scene loaded");
            debugText.textContent = "Scene loaded";
            
            // –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ü–µ–Ω—ã –∑–∞–ø—É—Å–∫–∞–µ–º MindAR
            setTimeout(() => {
                if (arScene && arScene.systems && arScene.systems['mindar-image-system']) {
                    mindarSystem = arScene.systems['mindar-image-system'];
                    console.log("Starting MindAR system...");
                    mindarSystem.start();
                    debugText.textContent = "MindAR starting";
                } else {
                    console.error("MindAR system not found in scene");
                    showError("MindAR system not found");
                }
            }, 1000);
        }
        
        function onARReady() {
            console.log("‚úÖ AR system ready");
            status.textContent = "AR active";
            debugText.textContent = "AR ready";
        }
        
        function onARError(event) {
            console.error("AR Error:", event.detail.error);
            showError("AR Error: " + event.detail.error);
            debugText.textContent = "AR error";
        }
        
        function onTargetFound() {
            console.log("üéØ Target found");
            trackingStatus.textContent = 'ACTIVE';
            trackingStatus.style.color = '#0f0';
            debugText.textContent = "Target found";
            
            // –ú–µ–Ω—è–µ–º –æ–±—ä–µ–∫—Ç –Ω–∞ –≤–∞—à—É –º–æ–¥–µ–ª—å –ø–æ—Å–ª–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Ç–∞—Ä–≥–µ—Ç–∞
            setTimeout(() => {
                const target = arScene.querySelector('[mindar-image-target]');
                if (target) {
                    target.innerHTML = '';
                    const model = document.createElement('a-gltf-model');
                    model.setAttribute('src', 'Ring.glb');
                    model.setAttribute('position', '0 0 0');
                    model.setAttribute('rotation', '0 0 0');
                    model.setAttribute('scale', '0.1 0.1 0.1');
                    model.setAttribute('animation', {
                        property: 'rotation',
                        to: '0 360 0',
                        loop: true,
                        dur: 10000,
                        easing: 'linear'
                    });
                    target.appendChild(model);
                    console.log("Model loaded");
                }
            }, 500);
        }
        
        function onTargetLost() {
            console.log("Target lost");
            trackingStatus.textContent = 'SEARCHING';
            trackingStatus.style.color = '#ff0';
            debugText.textContent = "Target lost";
        }
        
        // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –±–∏–±–ª–∏–æ—Ç–µ–∫
        setTimeout(checkLibraries, 1000);
        
        // –î–µ–±–∞–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        console.log("Page URL:", window.location.href);
        console.log("User Agent:", navigator.userAgent);
    </script>
</body>
</html>